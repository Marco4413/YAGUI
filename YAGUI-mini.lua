--[[
Copyright (c) 2019, hds536jhmk : https://github.com/hds536jhmk/YAGUI

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted, provided that the above
copyright notice and this permission notice appear in all copies.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
--]]
local a={ver="0.2",author="hds536jhmk",website="https://github.com/hds536jhmk/YAGUI"}local b={TOUCH="screen_touch",LOW_PRIORITY=1,HIGH_PRIORITY=2,ONDRAW=3,ONPRESS=4,ONCLOCK=5,ONEVENT=6}local c={vector2=function(d,e)return{x=d,y=e}end}local f={}f={join=function(g,h)if not h then h=""end;local i=""for j=1,#g do local k=g[j]i=i..tostring(k)if j<#g then i=i..h end end;return i end,split=function(i,h)local g={}while true do local l=i:find(h)if l then table.insert(g,i:sub(1,l-1))i=i:sub(l+1)else table.insert(g,i)break end end;return g end,compareVersions=function(m,n)local o=f.split(m,".")local p=f.split(n,".")local q=#o;local r=#p;for s=1,math.min(q,r)do if tonumber(o[s])>tonumber(p[s])then return 1 elseif tonumber(o[s])<tonumber(p[s])then return-1 end end;if q>r then return 1 elseif q<r then return-1 end;return 0 end}local t={isAreaPressed=function(u,v,d,e,w,x)if u>=d and u<d+w then if v>=e and v<e+x then return true end end;return false end,formatEventTable=function(y)local z={}z.name=y[1]if z.name=="mouse_click"then z.name=b.TOUCH;z.from="terminal"z.button=y[2]z.x=y[3]z.y=y[4]return z elseif z.name=="monitor_touch"then z.name=b.TOUCH;z.from=y[2]z.button=1;z.x=y[3]z.y=y[4]return z end;table.remove(y,1)z.parameters=y;return z end}local A={screen=term,clear_after_draw=true,buffer={pixels={},background=colors.black,isPixelCustom=function(self,d,e)d=tostring(d)e=tostring(e)if self.pixels[d]then if self.pixels[d][e]then return true end end;return false end,getPixel=function(self,d,e)d=tostring(d)e=tostring(e)if self:isPixelCustom(d,e)then return self.pixels[d][e]end;return{char=" ",foreground=self.background,background=self.background}end,setPixel=function(self,d,e,char,B,C)d=tostring(d)e=tostring(e)local D=self:getPixel(d,e)if char and#char==1 then D.char=char end;if B then D.foreground=B end;if C then D.background=C end;if not self.pixels[d]then self.pixels[d]={}end;self.pixels[d][e]=D end,clear=function(self)self.pixels={}end},clear=function(self)self.buffer:clear()end,draw=function(self)local E=self.screen;local F=self.buffer;local G=E.getBackgroundColor()local H=E.getTextColor()local I,J=E.getCursorPos()local w,x=E.getSize()for d=1,w do for e=1,x do E.setCursorPos(d,e)local D=F:getPixel(d,e)E.setBackgroundColor(D.background)E.setTextColor(D.foreground)E.write(D.char)end end;E.setBackgroundColor(G)E.setTextColor(H)E.setCursorPos(I,J)if self.clear_after_draw then self:clear()end end,point=function(self,d,e,K)self.buffer:setPixel(d,e," ",K,K)end,write=function(self,d,e,L,B,C)for M=0,#L-1 do char=L:sub(M+1,M+1)self.buffer:setPixel(d+M,e,char,B,C)end end,rectangle=function(self,d,e,w,x,K)for M=0,w-1 do for N=0,x-1 do self:point(d+M,e+N,K)end end end,line=function(self,O,P,Q,R,K)local function S(O,P,Q,R)local T=1;if O>Q then T=-1 end;local U=Q-O;local V=R-P;local W=1;if V<0 then W=-1;V=-V end;local X=2*V-U;local e=P;for d=O,Q,T do self:point(d,e,K)if X>0 then e=e+W;X=X-2*U end;X=X+2*V end end;local function Y(O,P,Q,R)local T=1;if P>R then T=-1 end;local U=Q-O;local V=R-P;local Z=1;if U<0 then Z=-1;U=-U end;local X=2*U-V;local d=O;for e=P,R,T do self:point(d,e,K)if X>0 then d=d+Z;X=X-2*V end;X=X+2*U end end;if math.abs(R-P)<math.abs(Q-O)then if O>Q then S(Q,R,O,P)else S(O,P,Q,R)end else if P>R then Y(Q,R,O,P)else Y(O,P,Q,R)end end end,circle=function(_,a0,a1,K)local a2=a1*a1;self:point(_,a0+a1,K)self:point(_,a0-a1,K)self:point(_+a1,a0,K)self:point(_-a1,a0,K)local d=1;local e=math.floor(math.sqrt(a2-1)+0.5)while d<e do self:point(_+d,a0+e,K)self:point(_+d,a0-e,K)self:point(_-d,a0+e,K)self:point(_-d,a0-e,K)self:point(_+e,a0+d,K)self:point(_+e,a0-d,K)self:point(_-e,a0+d,K)self:point(_-e,a0-d,K)d=d+1;e=math.floor(math.sqrt(a2-d*d)+0.5)end;if d==e then self:point(_+d,a0+e,K)self:point(_+d,a0-e,K)self:point(_-d,a0+e,K)self:point(_-d,a0-e,K)end end}local a3={}a3={setCallback=function(a4,z,a5)if z==b.ONDRAW then a4.callbacks.onDraw=a5 elseif z==b.ONPRESS then a4.callbacks.onPress=a5 elseif z==b.ONCLOCK then a4.callbacks.onClock=a5 end end,Clock={new=function(a6)local a7={clock=os.clock(),interval=a6,callbacks={onClock=function()end}}setmetatable(a7,a3.Clock)return a7 end,event=function(self,a8)if os.clock()>=self.clock+self.interval then self.clock=os.clock()self.callbacks.onClock(self,a8)return true end;return false end},Label={new=function(d,e,L,B,C)local a9={draw_priority=b.LOW_PRIORITY,focussed=false,hidden=false,text=L,pos=c.vector2(d,e),colors={foreground=B,background=C},callbacks={onDraw=function()end,onPress=function()end}}setmetatable(a9,a3.Label)return a9 end,draw=function(self)self.callbacks.onDraw(self)A:write(self.pos.x,self.pos.y,self.text,self.colors.foreground,self.colors.background)end,event=function(self,a8)if a8.name==b.TOUCH then if t.isAreaPressed(a8.x,a8.y,self.pos.x,self.pos.y,#self.text,1)then self.callbacks.onPress(self,a8)end end end},Button={new=function(d,e,w,x,L,B,aa,ab)local ac={draw_priority=b.LOW_PRIORITY,focussed=false,hidden=false,active=false,text=L,pos=c.vector2(d,e),size=c.vector2(w,x),colors={foreground=B,active_background=aa,unactive_background=ab},callbacks={onDraw=function()end,onPress=function()end}}setmetatable(ac,a3.Button)return ac end,draw=function(self)self.callbacks.onDraw(self)if self.active then A:rectangle(self.pos.x,self.pos.y,self.size.x,self.size.y,self.colors.active_background)else A:rectangle(self.pos.x,self.pos.y,self.size.x,self.size.y,self.colors.unactive_background)end;local ad=f.split(self.text,"\n")local ae=math.floor((self.size.y-#ad)/2)+self.pos.y;for N=0,#ad-1 do local k=ad[N+1]local af=math.floor((self.size.x-#k)/2)+self.pos.x;A:write(af,ae+N,k,self.colors.foreground)end end,event=function(self,a8)if a8.name==b.TOUCH then if t.isAreaPressed(a8.x,a8.y,self.pos.x,self.pos.y,self.size.x,self.size.y)then self:press()self.callbacks.onPress(self,a8)else self.focussed=false end end end,press=function(self)self.active=not self.active end}}a3.Clock.__index=a3.Clock;a3.Label.__index=a3.Label;a3.Button.__index=a3.Button;local ag={}ag={new=function(ah,ai)local aj={options={enabled=false,FPS_target=ah,EPS_target=ai},monitors={terminal=term},elements={high_priority={},low_priority={},loop={clock=a3.Clock.new(1/ah)}},callbacks={onDraw=function()end,onClock=function()end,onEvent=function()end}}setmetatable(aj,ag)return aj end,set_monitors=function(self,ak)self.monitors={}for j,k in pairs(ak)do if k=="terminal"then self.monitors[k]=term else if peripheral.getType(k)=="monitor"then self.monitors[k]=peripheral.wrap(k)end end end end,set_elements=function(self,al)self.elements.high_priority={}self.elements.low_priority={}for j,k in pairs(al)do if k.draw_priority==b.HIGH_PRIORITY then table.insert(self.elements.high_priority,k)else table.insert(self.elements.low_priority,k)end end end,draw_elements=function(self)self.callbacks.onDraw(self)local am=A.screen;for an,ao in pairs(self.monitors)do A.screen=ao;for j,ap in pairs(self.elements.low_priority)do if ap.draw then ap:draw()end end;for j,ap in pairs(self.elements.high_priority)do if ap.draw then ap:draw()end end;for j,ap in pairs(self.elements.loop)do if ap.draw then ap:draw()end end;A:draw()end;A.screen=am end,event_elements=function(self,aq)local a8=t.formatEventTable(aq)self.callbacks.onEvent(self,a8)if a8.name==b.TOUCH then local ar=false;for an,ao in pairs(self.monitors)do if a8.from==an then ar=true;break end end;if not ar then return end end;local as=false;for j,ap in pairs(self.elements.loop)do if as then ap.focussed=false else ap:event(a8)as=ap.focussed end end;for j,ap in pairs(self.elements.high_priority)do if as then ap.focussed=false else ap:event(a8)as=ap.focussed end end;for j,ap in pairs(self.elements.low_priority)do if as then ap.focussed=false else ap:event(a8)as=ap.focussed end end end,start=function(self)self.enabled=true;a3.setCallback(self.elements.loop.clock,b.ONCLOCK,function(at,a8)self.callbacks.onClock(self,a8)self:draw_elements()end)while self.enabled do local au=os.startTimer(1/self.options.EPS_target)local aq={os.pullEvent()}self:event_elements(aq)os.cancelTimer(au)end end,stop=function(self)self.enabled=false end}ag.__index=ag;local av={info=a,generic_utils=c,string_utils=f,event_utils=t,screen_buffer=A,gui_elements=a3,Loop=ag}for j,k in pairs(b)do av[j]=k end;return av